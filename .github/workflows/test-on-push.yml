name: Test

on:
  push:

jobs:
  test:
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        node-version: ['10.13.0', '12', '14', '16']
        nest-version: ['5', '6', '7', '']
        include:
          - { node-version: '8.9.0', nest-version: '5' }
          - { node-version: '8.9.0', nest-version: '6' }
          - { node-version: '8.9.0', nest-version: '7' }
          - { node-version: '8.9.0', nest-version: '' }

    steps:
      - name: Checkout
        uses: actions/checkout@v3
        with:
          ref: ${{ github.head_ref }}

      - name: Setup node
        uses: actions/setup-node@v3
        with:
          node-version: ${{ matrix.node-version }}

      # nestjs 5.x-7.x supports rxjs 6.x
      - name: Install rxjs
        if: >-
          startsWith(matrix.nest-version, '5') ||
          startsWith(matrix.nest-version, '6') ||
          startsWith(matrix.nest-version, '7')
        run: npm install rxjs@^6

      # node 8.x supports jest 25.x and ts-jest support typescript 3.x
      - name: Install jest 25
        if: startsWith(matrix.node-version, '8')
        run: npm install jest@^25 ts-jest@^25 typescript@^3

      # node 10.x supports jest 27.x
      - name: Install jest 27
        if: startsWith(matrix.node-version, '10')
        run: npm install jest@^27 ts-jest@^27

      - name: Install platform-express
        if: >-
          startsWith(matrix.nest-version, '6') ||
          startsWith(matrix.nest-version, '7')
        run: npm install @nestjs/platform-express@^${{ matrix.nest-version }}

      - name: Install nestjs
        if: matrix.nest-version
        run: npm install @nestjs/common@^${{ matrix.nest-version }} @nestjs/core@^${{ matrix.nest-version }} @nestjs/testing@^${{ matrix.nest-version }}

      - name: Test
        run: npm test

      - name: Build
        run: npm run build
